```{r}
library(tidyverse)
library(sf)
library(leaflet)
library(htmltools)
library(scales)
library(splitstackshape)
```

```{r}
# reading all the datasets
property_details<- read_csv('Affordable_Housing_DS6/property_details.csv')
assessments<- read_csv('Affordable_Housing_DS6/assessments.csv')
filtered_sales<- read_csv('Affordable_Housing_DS6/filtered_sales.csv')
barnes<- read_csv('Affordable_Housing_DS6/barnes.csv')
LIHTC<- read_csv('Affordable_Housing_DS6/LIHTC.csv')
LIHTC <- LIHTC[-c(1, 2, 3, 4, 5), ]
```

```{r}
# To view the dataframes
assessments
filtered_sales
LIHTC
property_details
barnes
```

# Removing duplicates from fitered_sales
```{r}
sales <- filtered_sales %>%
         filter(!duplicated(.))
# filtered_sales = 318834 observations
# sales = 311327 observations
```

# Creating column for sales year
```{r}
sales <- sales %>% 
          mutate(sale_year = str_extract(ownerdate, "([0-9]{4})"),
               sale_year = as.integer(sale_year))
```


Cleaning the property_details dataframe
```{r}
# Removing the () from centroid column before spliting it to latitude and longitude to generate geomactry
property_details$centroid <- gsub("[()]", "", property_details$centroid) #gsub function to remove () from centroid column
property_details
```

```{r}
# Spliting centroid column and renaming
property <- cSplit(property_details, "centroid", ",") %>%
rename("longitude" = "centroid_1","latitude" = "centroid_2")
property
```

```{r}
# droping na from property_details
property <- drop_na(property) 

#property_details = 156727
#property = 155837
```

```{r}
# converting to sf objects before merging
property <- st_as_sf(property, coords =c("longitude","latitude"), crs = 4326)
property
```


1. Using the sf library, find the closest development to each home.

```{r}

```

```{r}
#Converting LIHTC to an sf object
LIHTC <- st_as_sf(LIHTC, coords =c("LONGITUDE","LATITUDE"), crs = 4326)
```

```{r}
# Davidson county coordinates
map <- leaflet() %>%
  addProviderTiles(provider = "CartoDB.Positron") %>%
  setView(lng = -86.7819, lat = 36.1766, zoom = 10) %>%
  setMaxBounds(lng1 = -86.7819 + 1,
               lat1 = 36.1766 + 1,
               lng2 = -86.7819- 1,
               lat2 = 36.1766 - 1)

map
```


```{r}
# Get nearest feature
nearest_AH <- st_nearest_feature(property,LIHTC)
nearest_AH
```

2. Calculate the distance from each home its closest development.

```{r}
distance_miles <- st_distance(property, LIHTC[nearest_AH,], by_element = T) %>%
units::set_units(mi)
distance_miles
```


```{r}
# Merging two sf objects using cbind function 
property_LIHTC <- cbind (property, LIHTC[nearest_AH,])
property_LIHTC

# property_LIHTC = 155837 observations (same as property)
```

```{r}
# Adding distance columns to the merged  dataframe
property_LIHTC$distance = distance_miles
property_LIHTC
```

```{r}
property_LIHTC$distance <- gsub("[mi]", "", property_LIHTC$distance) #gsub function to remove [mi] from distance column
```

```{r}
property_sales_details <- merge(sales, property_LIHTC, by.x  = "apn" , by.y = "apn")
property_sales_details

# sales = 311327 observations
# property_sales_details = 309,739 observations
```


3. Filter the homes down to those that are within one mile of an affordable housing development.

```{r}
homes_one_mile <- property_sales_details %>%
  filter(property_sales_details$distance < 1)
homes_one_mile

# 139,026 observations
```



```{r}
# Add circle marker styling options
Nashville <- leaflet() %>%
  addProviderTiles(provider = "CartoDB.Positron") %>%
  setView(longitude = -86.7819, latitude = 36.1766, zoom = 10) %>%
  setMaxBounds(longitude1 = -86.7819 + 1,
               latitude1 = 36.1766 + 1,
               longitude2 = -86.7819- 1,
               latitude2 = 36.1766 - 1) %>%
  addCircleMarkers(data = homes_one_mile,
                   radius = 1,
                   color = "white",
                   weight = 0.25,
                   fillColor = "red",
                   fillOpacity = 0.75)

Nashville
```

```{r}
homes_one_mile <- homes_one_mile %>% 
  mutate(YRPIS_sale_year = YR_PIS - sale_year)
```

```{r}
homes_one_mile <- homes_one_mile %>% 
  mutate(time_window = case_when(
  YRPIS_sale_year < 0 ~ "post",
  ((YRPIS_sale_year >=0)&(YRPIS_sale_year < 2)) ~ "0-2yrs_prior",
  ((YRPIS_sale_year >=2)&(YRPIS_sale_year <=5)) ~ "2-5yrs_prior"
))
```

```{r}
homes_one_mile <- homes_one_mile %>%  
  mutate(group = case_when(
    ((distance <=0.5)&(time_window=="2-5yrs_prior")) ~ "pre",
    ((distance <=0.5)&(time_window=="0-2yrs_prior")) ~ "mid",
    ((distance <=0.5)&(time_window=="post")) ~ "post",
    ((distance >0.5)&
       ((time_window =="0-2yrs_prior")|(time_window=="2-5yrs_prior")|(time_window == "post") )) ~ "outside",
     TRUE ~ "other"
  ))
homes_one_mile
```

```{r}
table(homes_one_mile$group)
```



```{r}
homes_one_mile<- homes_one_mile %>%
  filter(homes_one_mile$group != "other")
homes_one_mile

```

```{r}
table(homes_one_mile$group)
```

#6 Add an id column containing id value for the development.

hud ID

#7. Create a column "Tpost" that, for homes in the "post" group gives the number of years that the sale occurred after the housing development was placed in service.

```{r}

homes_one_mile$Tpost <- 
  ifelse(homes_one_mile$group == "post", 
         homes_one_mile$sale_year - homes_one_mile$YR_PIS,
         NA)
homes_one_mile

```

#8. Create a column named "age" which gives the age of the home at the time of sale.
```{r}
homes_one_mile <- homes_one_mile %>%
  mutate(age = (sale_year - year_built))
homes_one_mile
```

#9. Filter down to only sales that took place within the five years before or after the associated development was placed in service. 




```{r}
filtered_sales_five_YR <- homes_one_mile %>%
  filter(abs(YRPIS_sale_year) <=5)
filtered_sales_five_YR
```

#Then build a linear model with target variable the sales amount using the following features:
square_footage
age of home at time of sale
group
year
tract How can you interpret the coefficients of this model?



```{r}
linear_model <- lm(amount ~ square_footage + age + group + sale_year + factor(tract), data = filtered_sales_five_YR)
summary(linear_model)
```


#10. Now, try a model with target being the log of the sale price.

```{r}
log_linear_model <- lm(log(amount) ~ square_footage + age + group + sale_year + factor(tract), data = filtered_sales_five_YR)
summary(log_linear_model)
```

