---
title: "R Notebook"
output: html_notebook
---
```{r}
rm(list = ls())
```



```{r}
library(sf)
library(leaflet)
library(htmltools)
library(scales)

library(tidyverse)
library(ggplot2)
library(units)
library(stringr)
```




```{r}
LIHTC <- read_csv("data/LIHTC_updated.csv")
sales <- read_csv("data/filtered_sales.csv")
properties <- read_csv("data/property_details.csv")
barnes <- read_csv("data/barnes.csv")
#assessments <- read_csv("data/assessments.csv")


```

drop duplicates for sales

```{r}
sales <- sales[!duplicated(sales), ]

```

Remove 9999 and 8888 from LIHTC YRPIS

```{r}
LIHTC <- subset(LIHTC, YR_PIS <8888)
```

```{r}

```


###1.  Using the sf library, find the closest development to each home. 
Hint: You can convert a tibble to an sf object using the st_as_sf function. 

Once converted, you can use the get_nearest_feature function.

```{r}
#convert to sf object
LIHTC <- st_as_sf(LIHTC, coords =c("LONGITUDE","LATITUDE"), crs =4326) 
```

```{r}
#remove () from centroid
properties$centroid <- gsub("[()]", "", properties$centroid)
```


```{r}
#separate centroid to lon and lat columns
properties <- separate(data = properties, col = centroid, into = c("LONGITUDE", "LATITUDE"), sep = ",")
```


```{r}
properties <- drop_na(properties)
```


```{r}
#Convert properties to sf object
properties_sf <- st_as_sf(properties, coords = c("LONGITUDE", "LATITUDE"), crs = 4326)
#now has a geometry column point(...)
```



```{r}
#for each feature in properties, the index of the nearest feature/geometry in LIHTC
#empty geometries result in NA
#nearest - index of the nearest development in LIHTC
nearest <- st_nearest_feature(properties_sf, LIHTC)
```

```{r}
names(which.max(nearest))
```
```{r}
summary(nearest)
```


#2. Calculate distance from each home to its closest development
```{r}
#LIHTC[nearest, ] - subsets only rows that are nearest developments
dist_miles = st_distance(properties_sf, LIHTC[nearest, ], by_element = TRUE) %>% 
  units::set_units(mi)
```

```{r}
LIHTC[nearest, ]
```
```{r}
LIHTC[nearest, ] %>% summarize(n_distinct(HUD_ID))
```
~156k rows, only 155 unique developments, LIHTC[nearest, ] lists the closest development for each property




```{r}
#join the nearest development to properties_sf

p_join = cbind(properties_sf, st_drop_geometry(LIHTC)[nearest, ])
```

```{r}
#add distance column (distance between property and its closest development)
p_join$distance <- dist_miles
```


```{r}
#p_join$distance
```

#3. Filter properties that are within a mile of a development
```{r}

#filter properties where distance <=1
one_mile <- p_join %>% drop_units() %>% 
  filter(distance<=1)

dim(one_mile)
```

```{r}
one_mile %>% summarise(max(distance))
```



#4. For the remaining homes, calculate new column "group" using case_when

##Merge one_mile and sales data
```{r}
one_mile_sales <- inner_join(one_mile, sales, by = "apn")
dim(one_mile_sales)
```


```{r}
#keep only rows where yr_alloc < 8888
#one_mile_sales <- subset(one_mile_sales, YR_ALLOC<8888)
#dim(one_mile_sales)
```

## Groups
sale_date of property: ownerdate
input year of development: YR_PIS

sale_date was 2-5 years prior to input_year: YR_PIS - ownerdate >=2 and <=5
sale_date was 0-2 years prior to input_year: YR_PIS - owner date >=0 and <2

```{r}
#Make owner_yr column from ownerdate
one_mile_sales <- one_mile_sales %>% 
  mutate(owner_yr = substr(ownerdate, 1, 4)) %>% 
  transform(owner_yr = as.numeric(owner_yr))

dim(one_mile_sales)
```

YRPIS_ownerYR = YR_PIS - owner_yr
  positive means sale date was before development (prior)
  negative means sale date was after development (post)
  
```{r}
one_mile_sales <- one_mile_sales %>% 
  mutate(YRPIS_ownerYR = YR_PIS - owner_yr)

dim(one_mile_sales)
```

```{r}
one_mile_sales <- one_mile_sales %>% 
  mutate(time_window = case_when(
  YRPIS_ownerYR <0 ~ "post",
  ((YRPIS_ownerYR>=0)&(YRPIS_ownerYR <2)) ~ "0-2yrs_prior",
  ((YRPIS_ownerYR >=2)&(YRPIS_ownerYR <=5)) ~ "2-5yrs_prior"
))
```

check unique values for time window (year groupings)

```{r}
table(one_mile_sales$group)
```



```{r}
one_mile_sales <- one_mile_sales %>%  
  mutate(group = case_when(
    ((distance <=0.5)&(time_window=="2-5yrs_prior")) ~ "pre",
    ((distance <=0.5)&(time_window=="0-2yrs_prior")) ~ "mid",
    ((distance <=0.5)&(time_window=="post")) ~ "post",
    ((distance >0.5)&
       ((time_window=="0-2yrs_prior")|(time_window=="2-5yrs_prior")|(time_window == "post"))) ~ "outside",
     TRUE ~ "other"
  ))
```



```{r}
table(one_mile_sales$group)
```
```{r}
one_mile_sales %>% filter(group == "outside") %>% select(group, distance, time_window, YR_PIS, owner_yr,  YRPIS_ownerYR ) %>% view()

dim(one_mile_sales)
```




```{r}
one_mile_sales %>% select(distance, YRPIS_ownerYR, time_window, group) %>% view()

```



#5. Filter out rows whose group is "other"

```{r}
one_mile_sales <- subset(one_mile_sales, group!="other")

dim(one_mile_sales)
```





#6. Add an id column containing the id value for the development.

HUD_ID

#7. Create a column "Tpost" that, for homes in the "post" group gives the number of years that the sale occurred after the housing development was placed in service

```{r}
one_mile_sales <- one_mile_sales %>% 
  mutate(Tpost = case_when(
  group=="post" ~ owner_yr-YR_PIS
))

dim(one_mile_sales)
```

```{r}
one_mile_sales %>% select(owner_yr, YR_PIS, group, Tpost) %>% view()

```

#8. Create a column named "age" which gives the age of the home at the time of sale.

```{r}
one_mile_sales <- one_mile_sales %>% 
  mutate(age = owner_yr - year_built)
```


#9. Filter down to only sales that took place within the five years before or after the associated development was placed in service.

```{r}
one_mi_five_yr <- one_mile_sales %>% 
  filter(abs(YRPIS_ownerYR)<=5)
dim(one_mi_five_yr)
```




# Multiple Linear Regression

```{r}
mlm <- lm(formula = amount ~ square_footage + age + group + owner_yr + tract,
          data = one_mi_five_yr)
```

```{r}
summary(mlm)
```

amount = -6.29E6+76.3(square_footage)-646(age)
        -1.22E4(groupoutside) -5.33E3(grouppost) -2.11E4(grouppre)
        +3.57E3(owner_yr) -2.25E-2(tract)
*When group is Mid (0-2 yrs prior) and all other variables=0, the price = -6.28E6??
Interpretation for group coefficients
* group mid is the reference group and other groups are compared to it.
* -1.22E4 is the difference in avg home price between Mid group and Outside group
  *homes outside 0.5 radius of devts cost ~12k less than homes built 0-2yrs prior
   within 0.5mi of devts
* -5.33E3 is the difference in price between Mid group and Post group.
  * p-value = 0.322, so the difference is not significant.
* -2.11E4 is the difference in price between Mid group and Pre group.
  *homes in Pre group (built 2-5 yrs prior of devt) cost ~21k less on avg than homes
   in Mid group(built 0-2 yrs prior of devt).


#10. Linear model with log(sale price)


```{r}
mlm <- lm(formula = log(amount) ~ square_footage + age + group + owner_yr + factor(tract),
          data = one_mi_five_yr)

summary(mlm)

```

```{r}
exp(coef(mlm)["grouppost"] - coef(mlm)["grouppre"])
```


```{r}
(exp(coef(mlm))-1)*100
```
*for every additional square foot, the sale price increases by 0.04%
*for each additional year of home age, the sale price decreases on average by 0.37%.
*for each additional year of sale , the sale price increases on average by 3.2%

Groups
*Group mid is the reference
*Group outside has 9.5% higher prices than group mid
*Group post has 5.2% lower prices than group mid (0-2yrs prior)
*Group pre (2-5yrs prior) has 1.3% lower prices than group mid(0-2yrs prior)

```{r}
log(100)
```

